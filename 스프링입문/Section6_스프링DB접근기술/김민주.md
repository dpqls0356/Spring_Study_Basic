## ğŸ» H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜

- [ì„¤ì¹˜ ë§í¬](https://h2database.com/html/main.html)
- JDBC URLì„ `jdbc:h2:tcp://localhost/~/test`ìœ¼ë¡œ ë³€ê²½ : ì†Œì¼“ì„ í†µí•´ì„œ ì ‘ê·¼
- `org.h2.jdbc.JdbcSQLNonTransientConnectionException`
  - home ê²½ë¡œì— `test.mv.db` íŒŒì¼ ë§Œë“¤ê¸°
- `generated by default as indentity` : Null ê°’ì¼ë•Œ DBê°€ ê°’ ìë™ìœ¼ë¡œ ì±„ì›€
- í”„ë¡œì íŠ¸ í´ë” ë‚´ì—ì„œ ë”°ë¡œ ë””ë ‰í† ë¦¬ë¥¼ íŒŒì„œ ì¿¼ë¦¬ë¬¸ ê´€ë¦¬í•˜ë©´ í¸í•¨

## ğŸ» ìˆœìˆ˜ JDBC

- build.gradle íŒŒì¼ì— ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
- `javax.sql.DataSource`ë¥¼ ìŠ¤í”„ë§ì—ê²Œ ì£¼ì…ë°›ì•„ì•¼í•¨

```java
private DataSource dataSource;

public class Repository(DataSource dataSource) {
    this.dataSource = dataSource;
}

public Object save(Object object) {
    String sql = "insert into object(value) values(?)";

    Connection connection = dataSource.getConnection();
    PreparedStatement pstmt = conn.prepareStatement(sql);
    // ìë™ ìƒì„±ëœ id ê°’ì„ ê°€ì ¸ì˜¤ê³  ì‹¶ë‹¤ë©´?
    // PreparedStatement pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATE_KEYS);

    pstmt.setString(1, object.getName());

    pstmt.excuteUpdate();
}

public Object get(Object object) {
    Connection connection = dataSource.getConnection();
    PreparedStatement pstmt = conn.prepareStatement(sql);

    pstmt.executeQuery();
    rs = pstmt.getGeneratedKeys();

    if (rs.next()) {
        ...
    }
}
```

- `Config`ì— `DataSource` ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì™€ `repository()`ì— ë“±ë¡ëœ ë¹ˆ ë³€ê²½
- ê°œë°©-íì‡„ ì›ì¹™(OCP, Open-Closed Principle) : í™•ì¥ì—ëŠ” ì—´ë ¤ìˆê³ , ë³€ê²½(ìˆ˜ì •)ì—ëŠ” ë‹«í˜€ìˆë‹¤.
  - ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • ì—†ì´ **ì„¤ì • ë³€ê²½ë§Œìœ¼ë¡œ êµ¬í˜„ í´ë˜ìŠ¤ ë³€ê²½ ê°€ëŠ¥**

## ğŸ» ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸

```java
@SpringBootTest
@Transactional
class ServiceIntegrationTest {
    @Autowired Service service;
    @Autowired Repository repository;
}
```

- `@SpringBootTest` : ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì™€ í…ŒìŠ¤íŠ¸ í•¨ê»˜ ì‹¤í–‰
- `@Transactional`
  - í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë³µí•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
  - ì´ì „ í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ DBì— ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ë°˜ë³µ ë¶ˆê°€
  - íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•´ì„œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë¡¤ë°±
  - ê²°ê³¼ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ê°€ DBì— ë°˜ì˜ ì•ˆë¨

## ğŸ» ìŠ¤í”„ë§ JdbcTemplate

- JdbcTemplate, MyBatis ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë°˜ë³µ ì½”ë“œë¥¼ ëŒ€ë¶€ë¶„ ì œê±°
  - ì¿¼ë¦¬ë¬¸ì€ ì§ì ‘ ì‘ì„±

```java
public class Repository {
    private final JdbcTemplate jdbcTemplate;

    @Autowired // ìƒëµ ê°€ëŠ¥
    public Repository(DataSource dataSource) {
        jdbcTemplate = new JdbcTemplate(dataSource);
    }

    public Optional<Object> find() {
        List<Obejct> result = jdbcTemplate.query("select * from object", rowMapper());
        return result.stream.findAny();
    }

    private RowMapper<Object> rowMapper() {
        return (rs, rowNum) -> {
            Object object = new Object();
            // setterë¡œ ê°ì²´ ë°ì´í„° ì €ì¥
            return object;
        };
    }
}
```

## ğŸ» JPA

- build.gradleì— dependency ì¶”ê°€, application.properties ì„¤ì •
- JPAëŠ” Java ì§„ì˜ì˜ í‘œì¤€ ì¸í„°í˜ì´ìŠ¤
  - êµ¬í˜„ : Hibernate, Eclipse Link ...

```java
@Entity
public class Domain {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long int;
}
```

- `@Entity`
- `@Id` : Primary Key
- `@GeneratedValue` : ìë™ ìƒì„± ê°’ ì €ì¥
  - `GenerationType.IDENTITY` : DB ìë™ ìƒì„±

```java
public class Repository {
    private final EntityManager em;

    public Domain save(Domain object) {
        em.persist(object);
        return object;
    }

    public Domain find(Long id) {
        return em.find(Domain.class, id);
    }

    public Optional<Domain> findByValue(String value) {
        // select m from Member m where m.name = :name", Member.class)
        return em.createQuery("query", Comain.class)
                .setParameter("value", value)
                .getResultList()
                .stream()
                .findAny();
    }

    public List<Domain> findAll() {
        // select m from Member m
        return em.createQuery("query", Domain.class).getResultList();
    }
}
```

```java
@Transactional
public class Service {
    ...
}
```

## ğŸ» ìŠ¤í”„ë§ ë°ì´í„° JPA

- ìŠ¤í”„ë§ JPAê°€ ìë™ìœ¼ë¡œ êµ¬í˜„ì²´ ë“±ë¡
- ê¸°ë³¸ì ì¸ CRUD, ë‹¨ìˆœ ì¡°íšŒ ì œê³µ

```java
@Configuration
public class Config {
    private final Repository repository;

    @Autowired
    public Config(Repository repository) {
        this.repository = repository;
    }

    @Bean
    public Service Service() {
        return new Service(repository);
    }
}

public interface Repository extends JpaRepository<Domain, Long> {
    Optional<Domain> findById(String id);
}
```
