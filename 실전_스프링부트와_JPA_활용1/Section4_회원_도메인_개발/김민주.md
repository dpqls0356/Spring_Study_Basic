## ğŸ«  íšŒì› ë„ë©”ì¸ ê°œë°œ

- MemberRepository.java

```java
// ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜(@Component í•˜ìœ„)
@Repository
public class MemberRepository {

    // EntityManager DI
    @PersistenceContext
    private EntityManager em;

    // EntityManager Factory DI
    @PersistenceUnit
    private EntityManagerFactory emf;

    public void save(Member member) {
        em.persist(member);
    }

    // ë‹¨ê±´ ì¡°íšŒ
    public Member findOne(Long id) {
        return em.find(Member.class, id);
    }

    public List<Member> findAll() {
        // ì—”í‹°í‹°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒ
        return em.createQuery("select m from member m", Member.class).getResultList() ;
    }

    public List<Member> findByName(String name) {
        return em.createQuery("select m from Member m where m.name = :name", Member.class)
                .setParameter("name", name)
                .getResultList();
    }
}
```

## ğŸ«  íšŒì› ì„œë¹„ìŠ¤ ê°œë°œ

- MemberService.java

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class MemberService {

    private final MemberRepository memberRepository;

    // ìƒì„±ìê°€ í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš° @Autowiredë¥¼ ìƒëµí•´ë„ ì•Œì•„ì„œ injection
    // @RequiredArgsConstructorë¡œ ìƒëµí•  ìˆ˜ ìˆìŒ
    // public MemberService(MemberRepository memberRepository) {
    //     this.memberRepository = memberRepository;
    // }

    /**
     * íšŒì›ê°€ì…
     */
    public long join(Member member) {
        validateDuplicateMember(member); // ì¤‘ë³µ íšŒì› ê²€ì¦
        memberRepository.save(member);
        return member.getId();
    }

    public void validateDuplicateMember(Member member) {
        List<Member > findMembers = memberRepository.findByName(member.getName());
        if(!findMembers.isEmpty()) {
            thrw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
        }
    }

    // íšŒì› ì „ì²´ ì¡°íšŒ
    // readOnly ê°’ì„ trueë¡œ ë‘ë©´ ì¡°íšŒ ì„±ëŠ¥ì„ ìµœì í™”
    public List<Member> findMembers() {
        return memberRepository.findAll();
    }

    // ë‹¨ê±´ ì¡°íšŒ
    public Member findOne(Long memberId) {
        return memberRepository.findOne(memberId);
    }
}
```

## ğŸ«  íšŒì› ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ìš”êµ¬ì‚¬í•­

- íšŒì›ê°€ì…ì„ ì„±ê³µí•´ì•¼ í•œë‹¤.
- íšŒì›ê°€ì… í•  ë•Œ ê°™ì€ ì´ë¦„ì´ ìˆìœ¼ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class MemberServiceTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;
    @Autowired EntityManager em;

    // @Transactional : ê¸°ë³¸ì ìœ¼ë¡œ rollback
    @Test
    public void íšŒì›ê°€ì…() throws Exception {
        // given
        Member member = new Member();
        member.setName("kim");

        // when
        Long saveId = memberService.join(member);

        // then
        assertEquals(member, memberRepository.findOne(saveId));
    }

    @Test(expected = IllegalStateException.class)
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() throws Exception {
        Member member1 = new Member();
        member1.setName("kim1");

        Member member2 = new Member();
        member2.setName("kim2");

        // memberSerive.join(member1);
        // try {
        // memberSerive.join(member2); // ì˜ˆì™¸ ë°œìƒ!!
        // } catch (IllegalStateException e) {
        //     return;
        // }

        // expected ì˜µì…˜ìœ¼ë¡œ ì½”ë“œë¥¼ ê°„ëµí•˜ê²Œ ì‘ì„±í•  ìˆ˜ ìˆìŒ
        memberSerive.join(member1);
        memberSerive.join(member2);

        // ì •ìƒ ì¢…ë£Œê°€ ë˜ë©´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
        fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.")
    }
}
```

### í…ŒìŠ¤íŠ¸ë¥¼ ê²©ë¦¬ëœ í™˜ê²½ì—ì„œ?

- ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ë™ì‘
- ì•„ì˜ˆ ì„¤ì •ì´ ì—†ìœ¼ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ë™ì‘í•¨
- test\resources\application.yml

```yml
spring:
  datasource:
    url: jdbc:h2:mem:test
    username: sa
    password:
    driver-class-name: org.h2.Driver
```
