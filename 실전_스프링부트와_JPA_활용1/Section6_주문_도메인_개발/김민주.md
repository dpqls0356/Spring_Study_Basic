## ğŸ«  ì£¼ë¬¸, ì£¼ë¬¸ìƒí’ˆ ì—”í‹°í‹° ê°œë°œ

- Order.java

```java
@Entity
@Table(name = "orders")
@Getter @Setter
public class Order {
    @Id @GeneratedValue
    @Column(name = "order_id")
    private Long id;

    @ManyToOne(fetch = LAZY)
    @JoinColumn(name = "member_id")
    private Member member;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<>();

    @OneToOne(fetch = LAZY, cascade = CascadeType.ALL)
    @JoinColumn(name = "delivery_id")
    private Delivery delivery;

    private LocalDateTime orderDate; // ì£¼ë¬¸ ì‹œê°„

    @Enumerated(EnumType.STRING)
    private OrderStatus status; // ì£¼ë¬¸ìƒíƒœ [ORDER, CANCEL]

    // == ì—°ê´€ê´€ê³„ ë©”ì„œë“œ == //
    public void setMember(Member member) {
        this.member = member;
        member.getOrders().add(this);
    }

    public void setDelevery(Delivery delivery) {
        this.delivery = delivery;
        delivery.setOrder(this);
    }

    // == ìƒì„± ë©”ì„œë“œ== //
    public static Order createOrder(Member member, Delivery delivery, OrderItem... orderItems) {
        Order order = new Order();
        order.setMember(member);
        order.setDelivery(delivery);
        for (OrderItem orderItem : orderItems) {
            order.addOrderItem(orderItem);
        }
        order.setStatus(OrderStatus.ORDER);
        order.setOrderDate(LocalDateTime.now());
        return order;
    }

    // == ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ == //
    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    public void cancel() {
        if (delivery.getStatus() == DeliveryStatus.COMP) {
            throw new IllegalStatusException("ì´ë¯¸ ë°°ì†¡ì™„ë£Œëœ ìƒí’ˆì€ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        this.setStatus(OrderStatus.CANCEL);
        for (OrderItem orderItem : orderItems) {
            orderItem.cancel();
        }
    }

    // == ì¡°íšŒ ë¡œì§ == //
    /**
     * ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ
     */
    public int getTotalPrice() {
        return orderItem.stream().mapToInt(OrderItem::getTotalPrice.sum());
    }
}
```

- OrderItem.java

```java
@Entity
@Getter @Setter
public class OrderItem {
    @Id @GeneratedValue
    @Column(name = "order_item_id")
    private Long id;

    @ManyToOne(fetch=LAZY)
    @JoinColumn(name = "item_id")
    private Item item;

    @ManyToOne(fetch=LAZY)
    @JoinColumn(name = "order_id")
    private Order order;

    private int orderPrice;
    private int count;

    // == ìƒì„± ë©”ì„œë“œ== //
    public static OrderItem createOrderItem(Item item, int orderPrice, int count) {
        OrderItem orderItem = new OrderItem();
        orderItem.setItem(item);
        orderItem.setOrderPrice(orderPrice);
        orderItem.setCount(count);

        item.removeStock(count);
        return orderItem;
    }

    // == ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ == //
    public void cancel() {
        // ì¬ê³  ìˆ˜ëŸ‰ ì›ë³µ
        getItem().addStock(count);
    }

    // == ì¡°íšŒ ë¡œì§ == //
    public int getTotalPrice() {
        return getOrderPrice() * getCount();
    }
}
```

## ğŸ«  ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ ê°œë°œ

```java
@Repository
@RequiredArgsConstructor
public class OrderRepository {
    private final EntityManager em;

    public void save(Order order) {
        em.persist(order);
    }

    public Order findOne(Long id) {
        return em.find(Order.class, id);
    }

    // public List<Order> findAll(OrderSearch orderSearch) {}
}
```

## ğŸ«  ì£¼ë¬¸ ì„œë¹„ìŠ¤ ê°œë°œ

- OrderService.java

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class OrderService {
    private final OrderRepository orderRepository;
    private final MemberRepository memberRepository;
    private final ItemRepository itemRepository;

    /**
     * ì£¼ë¬¸
     */
    @Transactional
    public Long order(Long memberId, Long itemId, int count) {
        // ì—”í‹°í‹° ì¡°íšŒ
        Member member = memberRepository.findOne(memberId);
        Item item = itemRepository.findOne(itemId);

        // ë°°ì†¡ì •ë³´ ìƒì„±
        Delivery delivery = new Delivery();
        delivery.setAddress(member.getAddress());

        // ì£¼ë¬¸ìƒí’ˆ ìƒì„±
        OrderItem.createOrderItem(item, item, item.getPrice(), count);

        // ì£¼ë¬¸ ìƒì„±
        Order.createOrder(member, delivery, orderItem);

        // ì£¼ë¬¸ ì €ì¥
        orderRepository.save(order);

        return order.getId();
    }

    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    @Transactional
    public void cancelOrder(Long order Id) {
        // ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
        Order order = orderRepository.findOne(orderId);
        // ì£¼ë¬¸ ì·¨ì†Œ
        order.cancel();
    }

    // ê²€ìƒ‰
    // public List<Order> findOrders(OrderSearch orderSearch) {
    //     return orderRepository.findAll(orderSearch);
    // }
}
```

- OrderItem.java

```java
// ì§€ì •ëœ ìƒì„±ì ì™¸ ê¸°ë³¸ ìƒì„±ìë¡œ ìƒì„± í›„ Setterì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±í•˜ëŠ” ë°©ë²•ì„ ë§‰ê³  ì‹¶ì„ ë•Œ
@NoArgsConstructor(access = AccessLevel.PROTECTED)

// ìœ„ ì–´ë…¸í…Œì´ì…˜ì€ ì•„ë˜ ì½”ë“œì™€ ê°™ë‹¤
protected OrderItem() {}
```

## ğŸ«  ì£¼ë¬¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class  OrederServiceTest {

    @Autowired EntityManager em;
    @Autowired OrderService orderService;
    @Autowired OrderRepository orderRepository;

    @Test
    public void ìƒí’ˆì£¼ë¬¸() throws Exception {
        Member member = createMember();
        Book book = createBook("ì‹œê³¨ JPA", 10000, 10);

        int orderCount = 2;

        Long orderId = orderService.order(member.getId(), book.getId(), orderCount);

        Order getOrder = orderRepository.findOne(orderId);

        assertEquals("ìƒí’ˆ ì£¼ë¬¸ì‹œ ìƒíƒœëŠ” ORDER", OrderStatus.ORDER, getOrder.getStatus());
        assertEquals("ì£¼ë¬¸í•œ ìƒí’ˆ ì¢…ë¥˜ ìˆ˜ê°€ ì •í™•í•´ì•¼ í•œë‹¤.", 1, getOrder.getOrderItems().size());
        assertEquals("ì£¼ë¬¸ ê°€ê²©ì€ ê°€ê²© * ìˆ˜ëŸ‰ì´ë‹¤.", 1000 * orderCount, getOrder.getTotalPrice());
        assertEquals("ì£¼ë¬¸ ìˆ˜ëŸ‰ë§Œí¼ ì¬ê³ ê°€ ì¤„ì–´ì•¼ í•œë‹¤.", 8, book.getStockQuantity());
    }

    @Test(expected = NotEnoughStockException.class)
    public void ìƒí’ˆì£¼ë¬¸_ì¬ê³ ìˆ˜ëŸ‰ì´ˆê³¼() throws Exception {
        Member member = createMember();
        Book book = createBook("ì‹œê³¨ JPA", 10000, 10);

        int orderCount = 11;

        orderService.order(member.getId(), item.getId(), orderCount);
        fail("ì¬ê³  ìˆ˜ëŸ‰ ë¶€ì¡± ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");
    }


    @Test
    public void ì£¼ë¬¸ì·¨ì†Œ() throws Exception {
        Member member = createMember();
        Book book = createBook("ì‹œê³¨ JPA", 10000, 10);

        int orderCount = 2;

        Long orderId = orderService.order(member.getid(), item.getId(), orderCount);

        orderService.cancelOrder(orderId);

        Order getOrder = orderRepository.findOne(orderId);

        assertEquals("ì£¼ë¬¸ ì·¨ì†Œì‹œ ìƒíƒœëŠ” CANCEL ì´ë‹¤.", OrderStatus.CANCEL, getOrder.getStatus());
        assertEquals("ì£¼ë¬¸ì´ ì·¨ì†Œëœ ìƒí’ˆì€ ê·¸ë§Œí¼ ì¬ê³ ê°€ ì¦ê°€í•´ì•¼ í•œë‹¤.", 10, item.book.getStockQuantity());
    }

    private Member createMember() {
        Member member = new Member();
        member.setName("íšŒì›1");
        member.setAddress(new Address("ì„œìš¸", "ê°•ê°€", "123-123"));
        em.persist(member);
        return member;
    }

    private Book createBook(String name, int price, int stockQuantity) {
        Book book = new Book();
        book.setName(name);
        book.setPrice(price);
        book.setStockQuantity(stockQuantity);
        em.persist(book);
        return book;
    }
}
```

## ğŸ«  ì£¼ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥ ê°œë°œ

- JPAì—ì„œ ë™ì  ì¿¼ë¦¬ ì²˜ë¦¬

```java
@Getter @Setter
public class OrderSearch {
    private String memberName; // íšŒì› ì´ë¦„
    private OrderStatus orderStatus; // ì£¼ë¬¸ ìƒíƒœ [ORDER, CANCEL]
}
```

- OrderRepository.java

```java
@Repository
@RequiredArgsConstructor
public class OrderRepository {
    private final EntityManager em;

    public void save(Order order) {
        em.persist(order);
    }

    public Order findOne(Long id) {
        return em.find(Order.class, id);
    }

    // ìˆ¨ì–´ìˆëŠ” ì˜¤ë¥˜ê°€ ë§ê³ , ìœ ì§€ë³´ìˆ˜ê°€ í˜ë“¤ì–´ì„œ ê¶Œì¥í•˜ì§€ ì•ŠëŠ” ë°©ë²•
    public List<Order> findAllByString(OrderSearch orderSearch) {
        String jsql = "select o from Order o join o.member m";
        boolean isFirstCondition = true;

        if (orderSearch.getOrderStatus() != null) {
            if(isFirstCondition) {
                spql += " where";
                isFirstCobndition = false;
            } else {
                jpql = " and";
            }
            jpql += " o.status = :status";
        }

        if(StringUtils.hasText(orderSearch.getMemberName())) {
            if(isFirstCondition) {
                jpql += " where";
                isFirstCondition = false;
            } else {
                jpql += " and";
            }
            jpql += " m.name like :name";
        }

        TypedQuery<Order> query = em.createQuery(jpql, Order.class).setMaxResults(1000);

        if(orderSearch.getOrderStatus() != null) {
            query = query.setParameter("status", orderSearch.getOrderStatus());
        }

        if(StringUtils.hasText(orderSearch.getMemberName())) {
            query = query.setParameter("name", orderSearch.getMemberName());
        }

        return query.getResultList();
    }

    /**
     * JPA Criteria - ìœ ì§€ë³´ìˆ˜ê°€ í˜ë“¤ê¸° ë•Œë¬¸ì— ì—­ì‹œ ê¶Œì¥í•˜ì§€ ì•ŠìŒ
     * Querydslë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ, ë™ì  ì¿¼ë¦¬ë¥¼ ê°•ë ¥í•˜ê²Œ í•´ê²°
     */
    public List<Order> findAllByCriteria(OrderSearch orderSearch) {
        CriteriaBuilder cb = em.getCriteriaBuilder();
        CriteriaQuery<Order> cq = cb.createQuery(Order.class);
        Root<Order> o = cq.from(Order.class);
        Join<Object, Object> m = o.join("member", JoinType.INNER);

        List<Predicate> criteria = new ArrayList<>();

        if(orderSearch.getOrderStatus() != null) {
            Predicate status = cb.equal(o.get("status"), orderSearch.getOrderStatus());
            criteria.add(status);
        }

        if(StringUtils.hasText(orderSearch.getMemberName())) {
            Predicate name = cb.like(m.<String>get("name"), "%" + orderSearch.getMemberName() + "%");
            criteria.add(name);
        }

        cq.where(cb.and(criteria.toArray(new Predicate[criteria.size()])));
        TypedQuery<Order> query = em.createQuery(cq).setMaxResults(1000);
        return query.getResultList();
    }
}
```
